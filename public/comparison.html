<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CogComp-NLP Comparison Tool</title>

    <link rel="stylesheet" type="text/css" href="./brat_client/static/style-vis.css"/>
    <link rel="stylesheet" type="text/css" href="./main.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.0/gh-fork-ribbon.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">

    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/headjs/1.0.3/head.min.js"></script>
    <script type="text/javascript">
        head.js(
            "https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js",
            "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js",
            "https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js",
            "/apelles.js"
        );
    </script>
</head>
<body>
<div class="container">
    <div class="jumbotron">
        <div style="float: right">
            <iframe src="https://ghbtns.com/github-btn.html?user=CogComp&repo=cogcomp-nlp&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px" style="margin-right: -20px"></iframe>
            <iframe src="https://ghbtns.com/github-btn.html?user=CogComp&repo=cogcomp-nlp&type=fork&count=true&size=large" frameborder="0" scrolling="0" width="158px" height="30px" style="margin-right: -20px"></iframe>
        </div>
        <h1>CogComp-NLP</h1>
        <p>
            This comparison tool displays two annotations side by side, with identical items hidden.
            <a href="https://github.com/CogComp/apelles" class="btn btn-danger btn-xs">Read More</a>
        </p>
    </div>
    <div id="main-content" style="overflow: visible;">
        <div id="input-area" class="row" style="width: 100%;">
            <p class="col-xs-12">Choose some pairs of annotation files with the same name in the two comparison folders</p>
            <select class="selectpicker col-md-5 col-xs-12" id="annotation-selector" data-actions-box="true" multiple>
            </select>
            <select class="selectpicker col-md-5 col-xs-12" id="view-selector" data-actions-box="true" multiple>
                <option value="LEMMA" selected>LEMMA</option>
                <option value="POS" selected>POS</option>
                <option value="SHALLOW_PARSE" selected>Shallow Parse</option>
                <option value="MENTION">Mention Detection</option>
                <option value="NER_CONLL" selected>NER-CoNLL</option>
                <option value="NER_ONTONOTES" selected>NER-Ontonotes</option>
                <option value="TIMEX3">Temporal Normalizer</option>
                <option value="SRL_NOM">SRL (Nom) </option>
                <option value="SRL_VERB">SRL (Verb) </option>
                <option value="PATH_LSTM_SRL">SRL (Path-LSTM) </option>
                <option value="SRL_PREP">SRL (preposition) </option>
                <option value="SRL_COMMA">SRL (Comma) </option>
                <option value="QUANTITIES">Quantities</option>
                <option value="DEPENDENCY">Dependency Tree (CogComp)</option>
                <option data-divider="true"></option>
                <option value="DEPENDENCY_STANFORD">Dependency Tree (Stanford)</option>
                <option value="STANFORD_COREF">Co-reference (Stanford) </option>
                <option value="STANFORD_RELATIONS">Relations (Stanford) </option>
                <option value="STANFORD_OPENIE">Open IE (Stanford) </option>
                <option value="ATTRIBUTION_RELATION">Attribution Relation</option>
            </select>
            <input type="submit" class="btn btn-success pull-right col-md-1 col-xs-6" id="compare-submit">
        </div>
        <hr>
        <div id="render-area"></div>
    </div>
</div>
<script type="text/javascript">
    head.ready(function () {
        const _ = apelles.lodash;

        const bratLocation = './brat_client';
        const BRAT_OPTIONS = {
            'brat_util': Util,
            'brat_webFontURLs': [
                bratLocation + '/static/fonts/PT_Sans-Caption-Web-Regular.ttf',
                bratLocation + '/static/fonts/Liberation_Sans-Regular.ttf'
            ]
        };

        // Return an array of the selected option values
        // select is an HTML select element
        function getSelectValues(select) {
            return _.map(select.find('option:selected'), _.property('value'));
        }

        function loadAvailableAnnotations() {
            $.ajax({ dataType: "json", type: "GET", url: '/list' }).then(function (files) {
                _.forEach(files, function (file) {
                    $('#annotation-selector').append($('<option>', {
                        selected: true,
                        value: file,
                        text: file
                    }));
                });
                $("#annotation-selector").selectpicker("refresh");
                $('#view-selector').selectpicker('selectAll');
            }, function (err) {
                console.log(err);
            })
        }

        function loadAnnotation(annotations) {
            return $.ajax({ data: { annotations: annotations }, dataType: "json", type: "GET", url: "/get" }).then(function (data) {
                return data;
            }, function (err) {
                console.log(err);
            })
        }

        function findViewInfosToRender(selectedViews, fetchedData) {
            var availableViews = apelles.getAvailableViews(fetchedData.jsonData);

            return _.map(_.filter(availableViews, function (viewInfo) {
                return $.inArray(viewInfo.type, apelles.supportedTypes) !== -1 &&
                    viewInfo.name !== "TOKENS" &&
                    selectedViews.includes(viewInfo.name);
            }), function(viewInfo) {
                return $.extend({ file: fetchedData.file }, viewInfo);
            });
        }

        function generateId() {
            // Convert to base 36 and return the first 10 characters after the decimal place
            return Math.random().toString(36).substr(2, 10);
        }

        function createDiv(container, options, content) {
            var div = $("<div>", $.extend({ id: 'div-' + generateId() }, options));
            if (content) {
                div.append(content);
            }
            container.append(div);
            return div;
        }

        function renderAnnotation(fetchedData, viewInfo, renderArea) {
            var div = createDiv(renderArea, {
                'class': 'alert alert-success visualization-block',
                role: 'alert',
                text: _.escape(viewInfo.name) + " // " + _.escape(_.last(viewInfo.type.split('.')))
            }, $("<span>", {
                'class': 'pull-right',
                text: _.escape(viewInfo.file)
            }));

            apelles.render(fetchedData.jsonData, div.attr('id'), viewInfo, BRAT_OPTIONS);
        }

        function fitColumn(columnCount) {
            switch (columnCount) {
                case 1:
                    return 'col-xs-12';
                case 2:
                case 4:
                    return 'col-md-6 col-xs-12';
            }
            return 'col-md-4 col-xs-12';
        }

        loadAvailableAnnotations();
        $("#compare-submit").click(function (eventData) {
            $("#render-area").empty();

            var selectedAnnotations = getSelectValues($('#annotation-selector'));
            var selectedViews = getSelectValues($('#view-selector'));

            loadAnnotation(selectedAnnotations).then(function (fetchedData) {
                var columnClass = fitColumn(fetchedData.folders.length);

                var headerDiv = createDiv($("#render-area"), { 'class': 'row' });
                _.forEach(fetchedData.folders, function (folder) {
                    var headerColumnDiv = createDiv(headerDiv, { 'class': columnClass });
                    createDiv(headerColumnDiv, {
                        'class': 'alert alert-info'
                    }, $("<p>", {
                        'class': 'text-center',
                        text: _.escape(folder)
                    }));
                });

                var fetchedDataArray = fetchedData.data;
                var viewInfosArray = _.map(fetchedDataArray, function (fetchedData) {
                    return findViewInfosToRender(selectedViews, fetchedData);
                });

                // Display all unique view types (unique type, name, and file name)
                var viewInfos = _.uniqWith(_.flatten(viewInfosArray), _.isEqual);
                var viewInfosWithData = apelles.comparator.compareJsonData(fetchedDataArray, viewInfos);

                _.forEach(viewInfosWithData, function (viewInfosWithData) {
                    var renderRowDiv = createDiv($("#render-area"), { 'class': 'row' });
                    _.forEach(viewInfosWithData.data, function (fetchedData) {
                        var renderColumnDiv = createDiv(renderRowDiv, { 'class': columnClass });
                        renderAnnotation(fetchedData, viewInfosWithData.viewInfo, renderColumnDiv);
                    });
                });
            }, function (err) {
                console.log(err);
            });
        });
    });
</script>
</body>
</html>
